# based on digitalocean.com's content 
# "How To Use HAProxy to Set Up HTTP Load Balancing on an Ubuntu VPS"
# @see https://www.digitalocean.com/community/tutorials/how-to-use-haproxy-to-set-up-http-load-balancing-on-an-ubuntu-vps
global
  daemon
  log 127.0.0.1 local0 notice
  maxconn 2048

defaults
  log global
  mode http
  option httplog
  option dontlognull
  retries 3
  option redispatch
  timeout connect 5000
  timeout client 10000
  timeout server 10000

  # errorfile 400 "${HAPROXY_ROOT_PATH}"/errors/400.http
  # errorfile 403 "${HAPROXY_ROOT_PATH}"/errors/403.http
  # errorfile 408 "${HAPROXY_ROOT_PATH}"/errors/408.http
  # errorfile 500 "${HAPROXY_ROOT_PATH}"/errors/500.http
  # errorfile 502 "${HAPROXY_ROOT_PATH}"/errors/502.http
  # errorfile 503 "${HAPROXY_ROOT_PATH}"/errors/503.http
  # errorfile 504 "${HAPROXY_ROOT_PATH}"/errors/504.http
  
  # haproxy status check URI
  # stats enable
  # stats uri /haproxy?stats
  # stats auth iamuser:on!yforte$t
  
frontend http-in
  mode http 
  bind *:80
  
  redirect scheme https code 301 if !letsencrypt-acl

  acl letsencrypt-acl path_beg /.well-known/acme-challenge/
  use_backend letsencrypt-backend if letsencrypt-acl
  
frontend https-in
  mode https
  bind *:443 ssl crt "${HAPROXY_CERTBOOT_CERTS_PATH}"/"${HDR_HOST_APP_URL}"/"${HDR_HOST_APP_URL}".pem crt "${HAPROXY_CERTBOOT_CERTS_PATH}"/"${HDR_HOST_PHPMYADMIN_URL}"/"${HDR_HOST_PHPMYADMIN_URL}".pem

  acl website-acl hdr(host) "${HDR_HOST_APP_URL}"
  acl phpmyadmin-acl hdr(host) "${HDR_HOST_PHPMYADMIN_URL}"

  use_backend website-backend if website-acl
  use_backend phpmyadmin-backend if phpmyadmin-acl

backend letsencrypt-backend
  server letsencrypt "${IPV4_ADDR_CERTBOT}":"${PORT_CERTBOT}"

backend website-backend
  mode http 
  server app "${BACKEND_APP_SERVER_ADDR}"

backend phpmyadmin-backend
  mode http 
  server phpmyadmin "${BACKEND_PHPMYADMIN_SERVER_ADDR}"