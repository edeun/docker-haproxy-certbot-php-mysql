# based on digitalocean.com's content 
# "How To Use HAProxy to Set Up HTTP Load Balancing on an Ubuntu VPS"
# @see https://www.digitalocean.com/community/tutorials/how-to-use-haproxy-to-set-up-http-load-balancing-on-an-ubuntu-vps
global
  daemon
  log 127.0.0.1 local0 notice
  maxconn 2048

defaults
  log global
  mode http
  option httplog
  option dontlognull
  retries 3
  option redispatch
  timeout connect 5000
  timeout client 10000
  timeout server 10000
  # haproxy status check URI
  stats enable
  stats uri /haproxy?stats
  stats auth iamuser:on!yforte$t
  
frontend certbot-in
  bind "*:${PORT_HTTP}"
  
  acl letsencrypt-acl path_beg /.well-known/acme-challenge/
  use_backend letsencrypt-backend if letsencrypt-acl

frontend http-in
  mode http 
  bind "*:${PORT_HTTP}"
  
  acl website-acl hdr(host) "${HDR_HOST_APP_URL}"
  acl phpmyadmin-acl hdr(host) "${HDR_HOST_PHPMYADMIN_URL}"

  use_backend website-backend if website-acl
  use_backend phpmyadmin-backend if phpmyadmin-acl

backend letsencrypt-backend
  server letsencrypt 127.0.0.1:54321

backend website-backend
  mode http 
  server app "${BACKEND_APP_SERVER_ADDR}"

backend phpmyadmin-backend
  mode http 
  server phpmyadmin "${BACKEND_PHPMYADMIN_SERVER_ADDR}"